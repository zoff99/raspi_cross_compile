machine:
  timezone:
    Europe/Berlin
  environment:
    RASPI_PATH: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH"
    RASPI_SYSROOT_: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/arm-linux-gnueabihf/sysroot"
    RASPI_TOOL_PREFIX: arm-linux-gnueabihf
    RASPI_INSTALL_DEST: "/home/ubuntu/installdest/"
    RASPI_TARGET_: arm-linux-gnueabi
    RASPI_HOST_: arm-linux-gnueabi
    RASPI_CXX: $RASPI_TOOL_PREFIX-g++
    RASPI_AR: $RASPI_TOOL_PREFIX-ar
    RASPI_RANLIB: $RASPI_TOOL_PREFIX-ranlib
    RASPI_CC: $RASPI_TOOL_PREFIX-gcc
    RASPI_LD: $RASPI_TOOL_PREFIX-ld
    RASPI_PKG_CONFIG_PATH: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/arm-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
    RASPI_s_: "/home/ubuntu/src/"
    RASPI_PKGSDIR: "/home/ubuntu/pkgs/"
dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake git libtool
    - sudo apt-get install yasm

    - mkdir ~/cc/
    - cd ~/cc ; git clone https://github.com/raspberrypi/tools
    - cd ~/cc/tools/ ; git checkout d820ab9c21969013b4e56c7e9cba25518afcdd44

    #- mkdir ~/rasp_sysroot/
    #- cd ~/rasp_sysroot/ ; git clone https://github.com/sdhibit/docker-rpi-raspbian
    #- cd ~/rasp_sysroot/docker-rpi-raspbian/ ; git checkout b05275e230317417b7575790789707c21cc639c1
    #- cd ~/rasp_sysroot/docker-rpi-raspbian/ ; xz -dv raspbian.*.xz ; mkdir sysroot ; cd sysroot ; tar -xvf ../raspbian.*.tar
    #- cd ~/rasp_sysroot/docker-rpi-raspbian/ ; ls -al ; ls -al sysroot

    - mkdir -p "$RASPI_PKG_CONFIG_PATH"
    - mkdir -p "RASPI_PKGSDIR"
    - ls -al "$RASPI_SYSROOT_"
    - mkdir -p "$RASPI_s_"
    - mkdir -p "$RASPI_PKGSDIR"

    - echo 'export PKGSDIR="$RASPI_PKGSDIR";export INSTALL_DEST="$RASPI_INSTALL_DEST";export PKG_CONFIG_PATH="$RASPI_PKG_CONFIG_PATH";export PATH="$RASPI_PATH";export CC="$RASPI_CC";export CXX="$RASPI_CXX";export AR="$RASPI_AR";export RANLIB="$RASPI_RANLIB";export LD="$RASPI_LD"' > ~/pp
    - chmod u+x ~/pp

    - printf '#! /bin/bash\n. ~/pp;rm -Rf ~/build/\nmkdir -p ~/build/\narg1_="$1";shift;cd ~/build/;$RASPI_s_/"$arg1_"/configure $* && make && make install\n' > ~/do_compile.sh
    - chmod a+rx ~/do_compile.sh
    - cat ~/do_compile.sh

    - printf '#! /bin/bash\n. ~/pp;rm -Rf "$INSTALL_DEST"\narg1_="$1";shift;cd ~/build/;$RASPI_s_/"$arg1_"/configure $* && make && make install && cd "$INSTALL_DEST" && tar -czvf "$PKGSDIR""/"pkg_"$arg1_".tar.gz . && rm -Rf "$INSTALL_DEST" \n' > ~/do_package.sh
    - chmod a+rx ~/do_package.sh
    - cat ~/do_package.sh
compile:
  override:
    - . ~/pp;type -a arm-linux-gnueabihf-g++
    - . ~/pp;type -a arm-linux-gnueabihf-gcc
    - . ~/pp;arm-linux-gnueabihf-g++ -v
    - . ~/pp;arm-linux-gnueabihf-gcc -v

    - . ~/pp;cd $RASPI_s_;git clone --depth=1 --branch=v1.3.0 https://github.com/yasm/yasm.git
    - . ~/pp;cd $RASPI_s_/yasm/;autoreconf -fi
    - ~/do_compile.sh "yasm" --prefix="$RASPI_SYSROOT_"/usr --disable-shared --disable-soname-versions --with-sysroot="$RASPI_SYSROOT_" --host="$RASPI_HOST_" --target="$RASPI_TARGET_"

    - . ~/pp;cd $RASPI_s_;git clone --depth=1 --branch=v1.6.0 https://github.com/webmproject/libvpx.git
    - export CROSS="arm-linux-gnueabihf-" ; ~/do_compile.sh "libvpx" --prefix="$RASPI_SYSROOT_"/usr --disable-examples --disable-unit-tests --target=generic-gnu --extra-cflags="--sysroot=$RASPI_SYSROOT_"
    - export CROSS="arm-linux-gnueabihf-" ; ~/do_package.sh "libvpx" --prefix="$RASPI_INSTALL_DEST" --disable-examples --disable-unit-tests --target=generic-gnu --extra-cflags="--sysroot=$RASPI_SYSROOT_"

    - . ~/pp;cd $RASPI_s_;git clone --depth=1 --branch=v1.1.3 https://github.com/xiph/opus.git
    - . ~/pp;cd $RASPI_s_/opus/;autoreconf -fi
    - ~/do_compile.sh "opus" --prefix="$RASPI_SYSROOT_"/usr --disable-shared --disable-soname-versions --target="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --host="$RASPI_TOOL_PREFIX"
    - ~/do_package.sh "opus" --prefix="$RASPI_INSTALL_DEST" --disable-shared --disable-soname-versions --target="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --host="$RASPI_TOOL_PREFIX"

    - . ~/pp;cd $RASPI_s_;git clone --depth=1 --branch=1.0.11 https://github.com/jedisct1/libsodium.git
    - . ~/pp;cd $RASPI_s_/libsodium/;autoreconf -fi
    - ~/do_compile.sh "libsodium" --prefix="$RASPI_SYSROOT_"/usr --disable-shared --disable-soname-versions --target="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --host="$RASPI_TOOL_PREFIX" --enable-minimal --disable-pie
    - ~/do_package.sh "libsodium" --prefix="$RASPI_INSTALL_DEST" --disable-shared --disable-soname-versions --target="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --host="$RASPI_TOOL_PREFIX" --enable-minimal --disable-pie

    - . ~/pp;cd $RASPI_s_;git clone https://github.com/TokTok/c-toxcore
    - . ~/pp;cd $RASPI_s_/c-toxcore/;git checkout 895de7ef26e7617769f2271345e414545c2581f8 # v0.1.6
    - . ~/pp;cd $RASPI_s_/c-toxcore/;autoreconf -fi
    - ~/do_compile.sh "c-toxcore" --prefix="$RASPI_SYSROOT_"/usr --disable-soname-versions --host="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --disable-testing --disable-rt
    - ~/do_package.sh "c-toxcore" --prefix="$RASPI_INSTALL_DEST" --disable-soname-versions --host="$RASPI_TOOL_PREFIX" --with-sysroot="$RASPI_SYSROOT_" --disable-testing --disable-rt

    - cp -av "$RASPI_PKGSDIR"/* $CIRCLE_ARTIFACTS/
test:
  override:
    - echo dummy

